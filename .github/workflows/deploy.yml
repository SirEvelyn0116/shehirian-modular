name: Deploy to GitHub Pages

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies (if needed)
      run: |
        if [ -f package.json ]; then npm ci || npm install; fi

    - name: Run build script
      run: node generate-index.js

    - name: Verify build output
      run: |
        echo "Build artifacts:"
        ls -la dist/
        echo "Checking for .nojekyll:"
        ls -la dist/.nojekyll || echo "WARNING: .nojekyll not found!"

    - name: Deploy to GitHub Pages
      run: |
        set -e

        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Prepare gh-pages deployment
        DEPLOY_DIR="./dist"
        TEMP_DEPLOY="$(mktemp -d)"

        # Copy built files to temp directory
        cp -r "$DEPLOY_DIR"/* "$TEMP_DEPLOY/" || {
          echo "ERROR: Failed to copy build artifacts"
          exit 1
        }

        # Initialize git in temp directory
        cd "$TEMP_DEPLOY"
        git init
        git add -A
        git commit -m "Deploy to GitHub Pages"

        # Tolerant remote removal: avoids failing when 'origin'
        # is missing in CI checkouts
        if git remote | grep -q '^origin$'; then
          git remote remove origin
        fi

        # Add remote and force push
        REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}"
        REPO_URL="${REPO_URL}@github.com/${{ github.repository }}.git"
        git remote add origin "$REPO_URL"
        git push --force origin HEAD:gh-pages

        # Cleanup: guarded rm to prevent failure with empty variable
        cd -
        if [ -n "$TEMP_DEPLOY" ]; then
          rm -rf -- "$TEMP_DEPLOY"
        fi
